## Exercise 5 - Mitigations for Meltdown Variants

### Meltdown-US-L1 (User/Supervisor L1 Cache)

#### Software Mitigations:
1. **KPTI (Kernel Page Table Isolation) / KAISER**
   - Separate page tables for kernel and user space
   - Kernel pages unmapped when in user mode
   - Prevents speculative access to kernel virtual addresses
   - **Effectiveness:** ✅ Complete mitigation
   - **Overhead:** 5-30% performance impact (SYSCALL-heavy workloads)

2. **Address Space Isolation**
   - Remove kernel mappings from user page tables
   - Only minimal trampoline code remains mapped
   - **Effectiveness:** ✅ Complete mitigation

#### Hardware Mitigations:
3. **Intel: RDCL_NO / Enhanced IBRS**
   - CPUs with `RDCL_NO` flag are not vulnerable
   - Data is zeroed on illegal access during speculation
   - **Effectiveness:** ✅ Complete mitigation (new CPUs)

4. **Speculative Store Bypass Disable (SSBD)**
   - Disable speculative execution across privilege boundaries
   - **Effectiveness:** ⚠️ Partial (high overhead)

---

### Meltdown-US-LFB (User/Supervisor Line Fill Buffer)

#### Hardware Mitigations:
1. **LFB Partitioning**
   - Separate LFB entries for different privilege levels
   - User processes cannot access kernel LFB entries
   - **Effectiveness:** ✅ Complete mitigation
   - **Availability:** Newer CPU microarchitectures

2. **LFB Flushing on Context Switch**
   - Clear LFB when switching between privilege levels
   - Flush on syscall entry/exit
   - **Effectiveness:** ✅ Complete mitigation
   - **Overhead:** Moderate performance impact

3. **Disable Hyperthreading**
   - Prevents cross-hyperthread LFB leaks
   - LFB is shared between hyperthreads on same core
   - **Effectiveness:** ✅ Mitigates cross-thread attacks
   - **Overhead:** ~30% performance loss (loses SMT benefits)

#### Software Mitigations:
4. **KPTI (Kernel Page Table Isolation)**
   - Also helps by unmapping kernel pages
   - **Effectiveness:** ⚠️ Partial (doesn't prevent LFB forwarding)

5. **Core Scheduling**
   - Only schedule trusted processes on same physical core
   - Prevents attacker/victim from sharing LFB
   - **Effectiveness:** ✅ Mitigates cross-hyperthread attacks
   - **Overhead:** Reduces CPU utilization

---

### Meltdown-P-L1 (Physical Address L1 Cache)

#### Software Mitigations:
1. **Remove Kernel Direct Physical Mapping**
   - Don't map all physical memory into kernel virtual space
   - Only map needed pages on-demand
   - **Effectiveness:** ✅ Complete mitigation
   - **Overhead:** Significant kernel redesign, performance impact

2. **KPTI (Kernel Page Table Isolation)**
   - Removes kernel's direct mapping from user page tables
   - **Effectiveness:** ✅ Complete mitigation (prevents access to direct map)

3. **Virtual Machine Isolation Enhancements**
   - Flush L1 cache on VM entry/exit
   - Prevents VM-to-VM leaks via physical addresses
   - **Effectiveness:** ✅ Mitigates VM escape
   - **Overhead:** Moderate (VM switches are already expensive)

#### Hardware Mitigations:
4. **L1D Flushing (L1D_FLUSH)**
   - CPU feature to flush L1 data cache
   - Use on context switches, VM exits
   - **Effectiveness:** ✅ Complete mitigation
   - **Overhead:** High (frequent flushes needed)

5. **Intel: RDCL_NO + Enhanced Page Tables**
   - Newer CPUs prevent speculative physical address access
   - EPT (Extended Page Tables) enforced during speculation
   - **Effectiveness:** ✅ Complete mitigation (new CPUs)

6. **Memory Encryption (AMD SEV, Intel TDX)**
   - Encrypt VM memory, each VM has unique key
   - Even if physical address is accessed, data is encrypted
   - **Effectiveness:** ✅ Protects confidentiality (but not integrity)

---

## Summary Table

| Variant | Primary Mitigation | Effectiveness | Performance Impact |
|---------|-------------------|---------------|-------------------|
| **Meltdown-US-L1** | KPTI | ✅ Complete | 5-30% |
| **Meltdown-US-LFB** | LFB Partitioning | ✅ Complete | Low (hardware) |
|  | Disable Hyperthreading | ✅ Complete | ~30% |
| **Meltdown-P-L1** | KPTI + Remove Direct Map | ✅ Complete | High |
|  | L1D Flush on VM exit | ✅ Complete | Moderate |
